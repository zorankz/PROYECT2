<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Área del Cliente Premium</title>
  <!-- External Resources -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Reset y estilos base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
      overflow-x: hidden;
    }
    
    /* Contenedor principal */
    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      position: relative;
    }
    
    /* Sidebar móvil */
    .sidebar {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      padding: 15px;
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1000;
      overflow-y: auto;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }
    
    .sidebar.active {
      transform: translateX(0);
      display: block;
    }
    
    /* Botón de menú */
    .menu-toggle {
      position: fixed;
      top: 15px;
      left: 15px;
      background: #2c3e50;
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    /* Perfil */
    .profile {
      text-align: center;
      padding: 20px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }
    
    .profile-pic {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid rgba(255,255,255,0.2);
      margin-bottom: 15px;
    }
    
    .profile h3 {
      font-size: 1.2rem;
      margin-bottom: 5px;
    }
    
    .profile p {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 5px;
    }
    
    .status {
      display: inline-block;
      padding: 3px 8px;
      background-color: #27ae60;
      border-radius: 12px;
      font-size: 0.7rem;
      margin-top: 5px;
    }
    
    /* Menú de navegación */
    .nav-menu {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .nav-item {
      background: transparent;
      color: white;
      border: none;
      padding: 12px 15px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 0.95rem;
      text-align: left;
      transition: all 0.3s;
    }
    
    .nav-item i {
      width: 24px;
      text-align: center;
    }
    
    .nav-item:hover, .nav-item.active {
      background-color: rgba(255,255,255,0.1);
    }
    
    /* Contenido principal */
    .main-content {
      flex: 1;
      padding: 70px 15px 80px;
      width: 100%;
    }
    
    .content-header {
      margin-bottom: 20px;
      text-align: center;
    }
    
    .content-title {
      font-size: 1.5rem;
      color: #2c3e50;
    }
    
    /* Paneles de contenido */
    .content-panel {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .content-panel.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Mensaje de bienvenida */
    .welcome-message {
      background-color: white;
      border-radius: 12px;
      padding: 30px 20px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      margin-top: 20px;
    }
    
    .welcome-icon {
      font-size: 3rem;
      color: #3498db;
      margin-bottom: 15px;
    }
    
    .welcome-message h2 {
      font-size: 1.3rem;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    
    .welcome-message p {
      color: #7f8c8d;
      font-size: 0.95rem;
    }
    
    /* Chat */
    .chat-container {
      background-color: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      height: calc(100vh - 160px);
      display: flex;
      flex-direction: column;
    }
    
    .chat-header {
      background-color: #3498db;
      color: white;
      padding: 15px;
      text-align: center;
    }
    
    .chat-header h2 {
      font-size: 1.2rem;
    }
    
    .chat-body {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background-color: #f5f7fa;
    }
    
    .message {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 18px;
      margin-bottom: 12px;
      font-size: 0.95rem;
      position: relative;
      line-height: 1.4;
      animation: messageIn 0.3s ease-out forwards;
      opacity: 0;
      transform: translateY(10px);
    }
    
    @keyframes messageIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message.received {
      background-color: white;
      border-bottom-left-radius: 5px;
      margin-right: auto;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .message.sent {
      background-color: #3498db;
      color: white;
      border-bottom-right-radius: 5px;
      margin-left: auto;
    }
    
    .message-time {
      display: block;
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 5px;
      text-align: right;
    }
    
    .welcome-chat-message {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .chat-instructions {
      font-size: 0.85rem;
      color: #7f8c8d;
      margin-top: 10px;
    }
    
    /* Input de chat */
    .chat-input-container {
      background-color: white;
      padding: 10px;
      border-top: 1px solid #eee;
    }
    
    .chat-input {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .chat-input input {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 25px;
      font-size: 0.95rem;
      outline: none;
    }
    
    .file-btn, .send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background-color: #3498db;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }
    
    .file-btn {
      background-color: #f1f1f1;
      color: #7f8c8d;
    }
    
    /* Paneles de información */
    .info-container {
      background-color: white;
      border-radius: 12px;
      padding: 20px 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    
    .info-container h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: #2c3e50;
      text-align: center;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    
    .info-card {
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
    }
    
    .info-card h3 {
      font-size: 0.9rem;
      color: #7f8c8d;
      margin-bottom: 5px;
    }
    
    .info-card p {
      font-size: 1rem;
      color: #2c3e50;
      font-weight: 500;
    }
    
    /* Documentos */
    .documents-container {
      background-color: white;
      border-radius: 12px;
      padding: 20px 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    
    .documents-container h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: #2c3e50;
      text-align: center;
    }
    
    .empty-state {
      text-align: center;
      padding: 30px 0;
      color: #7f8c8d;
    }
    
    .empty-state i {
      font-size: 2.5rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    
    /* Progreso */
    .progress-container {
      background-color: white;
      border-radius: 12px;
      padding: 20px 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    
    .progress-container h2 {
      font-size: 1.3rem;
      margin-bottom: 10px;
      color: #2c3e50;
      text-align: center;
    }
    
    .progress-description {
      text-align: center;
      color: #7f8c8d;
      font-size: 0.9rem;
      margin-bottom: 20px;
    }
    
    .progress-wrapper {
      margin-bottom: 25px;
    }
    
    .progress-title {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    
    .progress-bar {
      height: 10px;
      background-color: #f1f1f1;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3498db, #2ecc71);
      border-radius: 5px;
      transition: width 0.5s ease;
    }
    
    .progress-text {
      font-size: 0.85rem;
      color: #7f8c8d;
      text-align: center;
    }
    
    /* Hitos */
    .progress-steps {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      padding: 1rem 0;
      position: relative;
    }
    
    .progress-steps::before {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      left: 27px;
      width: 3px;
      background: linear-gradient(to bottom, #e0e0e0, #e0e0e0);
      z-index: 1;
      border-radius: 4px;
    }
    
    .step {
      display: flex;
      gap: 1rem;
      position: relative;
      z-index: 2;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .step.visible {
      opacity: 1;
      transform: translateY(0);
    }
    
    .step-icon {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
    }
    
    .step-info {
      flex-grow: 1;
      padding-bottom: 1.5rem;
    }
    
    .step-info h3 {
      margin: 0 0 0.3rem 0;
      font-size: 1rem;
      color: #333;
      font-weight: 600;
    }
    
    .step-info p {
      margin: 0;
      font-size: 0.85rem;
      color: #666;
    }
    
    /* Estados de hitos */
    .step.pending .step-icon {
      background: linear-gradient(135deg, #fff3cd, #ffecb3);
      color: #ffb300;
      border: 2px solid #ffc107;
    }
    
    .step.current .step-icon {
      background: linear-gradient(135deg, #cce5ff, #a3d0ff);
      color: #0062cc;
      border: 2px solid #007bff;
    }
    
    .step.completed .step-icon {
      background: linear-gradient(135deg, #d4edda, #b8e0c1);
      color: #218838;
      border: 2px solid #28a745;
    }
    
    /* Modal de archivos */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      z-index: 1002;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background-color: white;
      width: 90%;
      max-width: 400px;
      border-radius: 12px;
      padding: 20px;
      position: relative;
    }
    
    .close-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #7f8c8d;
    }
    
    .modal-content h3 {
      margin-bottom: 15px;
      text-align: center;
      color: #2c3e50;
    }
    
    .file-uploader {
      margin-bottom: 20px;
    }
    
    .drop-area {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .drop-area.highlight {
      border-color: #3498db;
      background-color: rgba(52, 152, 219, 0.05);
    }
    
    .drop-area i {
      font-size: 2.5rem;
      color: #3498db;
      margin-bottom: 10px;
    }
    
    .drop-area p {
      margin-bottom: 15px;
      color: #7f8c8d;
    }
    
    .btn-select-file {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      font-size: 0.9rem;
    }
    
    .file-preview {
      margin-top: 15px;
      text-align: center;
    }
    
    .file-preview img {
      max-width: 100%;
      max-height: 150px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    
    .modal-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    
    .modal-actions button {
      padding: 8px 20px;
      border-radius: 5px;
      border: none;
      font-size: 0.9rem;
    }
    
    .btn-cancel {
      background-color: #f1f1f1;
      color: #7f8c8d;
    }
    
    .btn-send {
      background-color: #3498db;
      color: white;
    }
    
    .btn-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Modal de foto ampliada */
    .modal-foto {
      display: none;
      justify-content: center;
      align-items: center;
      position: fixed;
      z-index: 1002;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
    }
    
    .modal-foto.activo {
      display: flex;
    }
    
    .contenido-modal {
      max-width: 90%;
      max-height: 80%;
      border-radius: 10px;
    }
    
    .cerrar-modal {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 2rem;
      color: white;
      cursor: pointer;
    }
    
    /* Animaciones */
    .floating {
      animation: floating 3s ease-in-out infinite;
    }
    
    @keyframes floating {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
    
    .ripple {
      position: relative;
      overflow: hidden;
    }
    
    .ripple:after {
      content: "";
      display: block;
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
      background-repeat: no-repeat;
      background-position: 50%;
      transform: scale(10, 10);
      opacity: 0;
      transition: transform .5s, opacity 1s;
    }
    
    .ripple:active:after {
      transform: scale(0, 0);
      opacity: 0.3;
      transition: 0s;
    }
    
    /* Responsive */
    @media (min-width: 768px) {
      .info-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Botón de menú móvil -->
    <button class="menu-toggle" id="menu-toggle">
      <i class="fas fa-bars"></i>
    </button>
    
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
      <div class="profile">
        <img id="client-photo" src="https://i.pravatar.cc/150?img=32" alt="Foto de perfil" class="profile-pic floating" style="cursor: pointer;">
        <h3 id="client-name">Alex Johnson</h3>
        <p id="client-status">Cliente Premium</p>
        <small class="status">En línea</small>
      </div>

      <nav class="nav-menu">
        <button class="nav-item active" data-view="chat">
          <i class="fas fa-comment-dots"></i>
          <span>Chat</span>
        </button>
        <button class="nav-item" data-view="info">
          <i class="fas fa-user"></i>
          <span>Mi Información</span>
        </button>
        <button class="nav-item" data-view="documentos">
          <i class="fas fa-folder"></i>
          <span>Documentos</span>
        </button>
        <button class="nav-item" data-view="progreso">
          <i class="fas fa-chart-line"></i>
          <span>Mi Progreso</span>
        </button>
        <button class="nav-item" data-view="dependientes">
          <i class="fas fa-users"></i>
          <span>Dependientes</span>
        </button>
      </nav>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
      <header class="content-header">
        <h1 class="content-title" id="vista-titulo">Chat con Asesor</h1>
      </header>

      <!-- Welcome Message -->
      <div class="welcome-message" id="welcome-box">
        <div class="welcome-content">
          <i class="fas fa-user-circle welcome-icon"></i>
          <h2>Bienvenido a tu Área Privada</h2>
          <p>Selecciona una opción del menú para comenzar</p>
        </div>
      </div>

      <!-- Chat Panel -->
      <section id="vista-chat" class="content-panel">
        <div class="chat-container">
          <div class="chat-header">
            <h2>Conversación con tu Asesor</h2>
          </div>
          
          <div class="chat-body" id="chat-body">
            <div id="messages-container">
              <div class="welcome-chat-message">
                <div class="message received">
                  ¡Hola <span id="client-name-chat">Alex</span>! ¿En qué puedo ayudarte hoy?
                  <span class="message-time">10:30 AM</span>
                </div>
                <p class="chat-instructions">Escribe tu mensaje en el cuadro de abajo para comenzar la conversación</p>
              </div>
            </div>
          </div>
          
          <div class="chat-input-container">
            <div class="chat-input">
              <input type="text" id="chat-message" placeholder="Escribe tu mensaje...">
              <button class="file-btn ripple" id="file-btn">
                <i class="fas fa-paperclip"></i>
              </button>
              <button class="send-btn ripple" id="send-btn">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Information Panel -->
      <section id="vista-info" class="content-panel oculto">
        <div class="info-container">
          <h2>Mi Información Personal</h2>
          <div class="info-grid">
            <div class="info-card">
              <h3>Nombre Completo</h3>
              <p id="info-nombre">Alex Johnson</p>
            </div>
            <div class="info-card">
              <h3>Correo Electrónico</h3>
              <p id="info-email">alex.johnson@example.com</p>
            </div>
            <div class="info-card">
              <h3>Teléfono</h3>
              <p id="info-phone">+1 (555) 123-4567</p>
            </div>
            <div class="info-card">
              <h3>ID de Cliente</h3>
              <p id="info-id">CL-2023-001</p>
            </div>
            <div class="info-card">
              <h3>Fecha de Registro</h3>
              <p id="info-registro">15 Ene 2023</p>
            </div>
            <div class="info-card">
              <h3>Último Acceso</h3>
              <p id="info-acceso">Hoy, 10:15 AM</p>
            </div>
            <div class="info-card">
              <h3>Cuenta USCIS</h3>
              <p id="info-uscis">No registrado</p>
            </div>
            <div class="info-card">
              <h3>Contraseña</h3>
              <p id="info-password">No proporcionada</p>
            </div>
            <div class="info-card">
              <h3>Detalles de Solicitud</h3>
              <p id="info-detalles">Sin detalles disponibles</p>
            </div>
            <div class="info-card">
              <h3>Tipo de Proceso</h3>
              <p id="info-proceso">No especificado</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Documents Panel -->
      <section id="vista-documentos" class="content-panel oculto">
        <div class="documents-container">
          <h2>Mis Documentos</h2>
          <div class="documents-list" id="documents-list">
            <div class="empty-state">
              <i class="fas fa-folder-open"></i>
              <p>No hay documentos disponibles</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Progress Panel -->
      <section id="vista-progreso" class="content-panel oculto">
        <div class="progress-container">
          <h2>Progreso de mi Caso</h2>
          <p class="progress-description">Aquí puedes ver el avance de tu proceso</p>
          
          <div class="progress-wrapper">
            <div class="progress-title">
              <span>Completado</span>
              <span id="progress-percent">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <p class="progress-text" id="progress-text">El proceso comenzará una vez completado el registro y pago.</p>
          </div>
          
          <div class="progress-steps" id="progress-steps">
            <!-- Los hitos se agregarán dinámicamente aquí -->
          </div>
        </div>
      </section>

      <!-- Dependientes Panel -->
      <section id="vista-dependientes" class="content-panel oculto">
        <div class="info-container">
          <h2>Mis Dependientes</h2>
          <p class="progress-description">Aquí verás la información de los familiares incluidos en tu caso.</p>
          
          <div class="info-grid" id="dependientes-lista">
            <!-- Los dependientes se mostrarán aquí -->
            <div class="info-card">
              <h3>Ejemplo</h3>
              <p>Nombre: María López</p>
              <p>Parentesco: Hija</p>
              <p>Edad: 12 años</p>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- File Upload Modal -->
  <div id="file-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h3>Seleccionar Archivo</h3>
      <div class="file-uploader">
        <input type="file" id="file-input" hidden>
        <div class="drop-area" id="drop-area">
          <i class="fas fa-cloud-upload-alt"></i>
          <p>Arrastra tu archivo aquí o haz clic para seleccionar</p>
          <button class="btn-select-file">Seleccionar Archivo</button>
        </div>
        <div class="file-preview" id="file-preview"></div>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel">Cancelar</button>
        <button class="btn-send" disabled>Enviar Archivo</button>
      </div>
    </div>
  </div>

  <!-- MODAL PARA AMPLIAR FOTO -->
  <div id="modal-foto" class="modal-foto">
    <span class="cerrar-modal">&times;</span>
    <img id="foto-ampliada" class="contenido-modal" src="" alt="Foto ampliada">
  </div>

  <!-- JavaScript Resources -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    // Obtener ID del cliente desde la URL
    const urlParams = new URLSearchParams(window.location.search);
    const clienteId = urlParams.get('id');

    if (!clienteId) {
      window.location.href = 'login-cliente.html';
    }

    console.log('Cliente ID:', clienteId);

    // Conexión con el servidor Socket.io
    const socket = io('https://jawfish-saving-grossly.ngrok-free.app');

    socket.on('connect', () => {
      console.log('🟢 Conectado al servidor:', socket.id);
      if (clienteId) {
        console.log('Uniendo al cliente:', clienteId);
        socket.emit('unirse', clienteId);
        cargarDatosDelCliente();
        cargarMensajesDelCliente(clienteId);
        cargarProgresoDelCliente(clienteId);
      } else {
        console.error('No se proporcionó ID de cliente.');
      }
    });

    socket.on('disconnect', () => {
      console.log('🔴 Desconectado del servidor');
    });

    socket.on('progreso-actualizado', () => {
      console.log('📈 Progreso actualizado recibido del servidor');
      cargarProgresoDelCliente(clienteId);
      const barra = document.getElementById('progress-fill');
      if (barra) {
        barra.classList.add('resaltado');
        setTimeout(() => barra.classList.remove('resaltado'), 1000);
      }
    });

    let mensajesCargados = new Set();

    function scrollToBottom() {
      const container = document.getElementById('messages-container');
      if (container) {
        setTimeout(() => {
          container.scrollTop = container.scrollHeight;
        }, 50);
        container.scrollTo({
          top: container.scrollHeight,
          behavior: 'smooth'
        });
      } else {
        console.error('Contenedor de mensajes no encontrado.');
      }
    }

    // Escuchar mensajes del ASESOR
    socket.on('mensaje-asesor', (mensaje) => {
      const container = document.getElementById('messages-container');
      const msgId = mensaje._id || mensaje.fecha;

      if (!mensajesCargados.has(msgId)) {
        const msgEl = document.createElement('div');
        msgEl.className = 'message received';
        msgEl.innerHTML = `
          ${mensaje.texto}
          <span class="message-time">
            ${new Date(mensaje.fecha).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
          </span>
        `;
        container.appendChild(msgEl);
        mensajesCargados.add(msgId);
        scrollToBottom();
      } else {
        console.warn('Mensaje duplicado detectado:', msgId);
      }
    });

    // Client Data Functions
    async function cargarDatosDelCliente() {
      if (!clienteId) {
        console.error("ID de cliente no proporcionado.");
        return;
      }

      try {
        const res = await fetch(`https://jawfish-saving-grossly.ngrok-free.app/clientes`);
        const data = await res.json();

        const cliente = data.find(c => c.id === clienteId);
        if (!cliente) {
          console.error("Cliente no encontrado.");
          return;
        }

        actualizarInterfazCliente(cliente);
      } catch (err) {
        console.error("Error al obtener cliente:", err);
      }
    }

    function actualizarInterfazCliente(cliente) {
      document.getElementById('client-name').textContent = cliente.nombre;
      document.getElementById('client-name-chat').textContent = cliente.nombre.split(' ')[0];
      document.getElementById('info-nombre').textContent = cliente.nombre;
      document.getElementById('info-email').textContent = cliente.correo || 'No proporcionado';
      document.getElementById('info-phone').textContent = cliente.telefono || 'No proporcionado';
      document.getElementById('info-id').textContent = cliente.id;
      document.getElementById('info-registro').textContent = new Date(cliente.fechaCreacion).toLocaleDateString();
      document.getElementById('info-uscis').textContent = cliente.uscis || 'No registrado';
      document.getElementById('info-password').textContent = cliente.password || 'No proporcionada';
      document.getElementById('info-detalles').textContent = cliente.detalles || 'Sin detalles disponibles';
      document.getElementById('info-proceso').textContent = cliente.proceso || 'No especificado';
      
      if (cliente.foto) {
        const img = document.getElementById('client-photo');
        img.src = cliente.foto;
      }
    }

    // Ampliar foto de perfil
    const imgPerfil = document.querySelector('#client-photo');
    const modalFoto = document.querySelector('#modal-foto');
    const fotoAmpliada = document.querySelector('#foto-ampliada');
    const cerrarModal = document.querySelector('.cerrar-modal');

    imgPerfil.addEventListener('click', () => {
      fotoAmpliada.src = imgPerfil.src;
      modalFoto.classList.add('activo');
    });

    cerrarModal.addEventListener('click', () => {
      modalFoto.classList.remove('activo');
    });

    modalFoto.addEventListener('click', (e) => {
      if (e.target === modalFoto) {
        modalFoto.classList.remove('activo');
      }
    });

    async function cargarMensajesDelCliente(id) {
      if (!id) {
        console.error("ID de cliente no proporcionado en cargarMensajesDelCliente.");
        return;
      }

      try {
        console.log('Intentando cargar mensajes para el cliente:', id);
        const res = await fetch(`https://jawfish-saving-grossly.ngrok-free.app/mensajes/${id}`);
        
        if (!res.ok) {
          throw new Error(`Error HTTP: ${res.status} - ${res.statusText}`);
        }

        const mensajes = await res.json();
        console.log('Mensajes recibidos del servidor:', mensajes);

        const messagesContainer = document.getElementById('messages-container');
        if (!messagesContainer) {
          console.error('Contenedor de mensajes (#messages-container) no encontrado.');
          return;
        }

        // Limpiar el contenedor y resetear el historial
        messagesContainer.innerHTML = '';
        mensajesCargados.clear();

        // Mostrar mensaje de bienvenida solo si NO hay mensajes en la base de datos
        if (!Array.isArray(mensajes) || mensajes.length === 0) {
          console.log('No hay mensajes previos. Mostrando mensaje de bienvenida.');
          const welcomeMsg = document.createElement('div');
          welcomeMsg.className = 'welcome-chat-message';
          welcomeMsg.innerHTML = `
            <div class="message received">
              ¡Hola <span id="client-name-chat">Cliente</span>! ¿En qué puedo ayudarte hoy?
              <span class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
            </div>
            <p class="chat-instructions">Escribe tu mensaje en el cuadro de abajo para comenzar la conversación</p>
          `;
          messagesContainer.appendChild(welcomeMsg);
          return;
        }

        // Renderizar mensajes del historial
        mensajes.forEach(msg => {
          const msgId = msg._id || msg.fecha;

          if (!mensajesCargados.has(msgId)) {
            const msgEl = document.createElement('div');
            msgEl.className = 'message ' + (msg.autor === 'cliente' ? 'sent' : 'received');
            msgEl.innerHTML = `
              ${msg.texto || 'Mensaje sin texto'}
              <span class="message-time">
                ${new Date(msg.fecha).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
              </span>
            `;
            messagesContainer.appendChild(msgEl);
            mensajesCargados.add(msgId);
          } else {
            console.warn('Mensaje duplicado detectado (historial):', msgId);
          }
        });

        scrollToBottom();
      } catch (err) {
        console.error("Error cargando mensajes:", err);
        const messagesContainer = document.getElementById('messages-container');
        if (messagesContainer) {
          const errorMsg = document.createElement('div');
          errorMsg.className = 'message error';
          errorMsg.textContent = 'No se pudieron cargar los mensajes. Inténtalo de nuevo.';
          messagesContainer.appendChild(errorMsg);
          scrollToBottom();
        }
      }
    }

    async function cargarArchivosDelCliente(id) {
      try {
        const res = await fetch(`https://jawfish-saving-grossly.ngrok-free.app/archivos/${id}`);
        const archivos = await res.json();

        const lista = document.getElementById('documents-list');
        lista.innerHTML = '';

        if (archivos.length === 0) {
          lista.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-folder-open"></i>
              <p>No hay documentos disponibles</p>
            </div>`;
          return;
        }

        archivos.forEach(file => {
          const card = document.createElement('div');
          card.className = 'document-card';

          const isPDF = file.nombre.toLowerCase().endsWith('.pdf');
          const icon = isPDF
            ? `<i class="fas fa-file-pdf fa-3x"></i>`
            : `<img src="${file.url}" alt="${file.nombre}" class="thumbnail">`;

          card.innerHTML = `
            <div class="document-preview">${icon}</div>
            <div class="document-info">
              <p class="file-name">${file.nombre}</p>
               <a href="${file.base64}" download="${file.nombre}" class="btn-download"><i class="fas fa-download"></i> Descargar</a>
            </div>
          `;

          lista.appendChild(card);
        });
      } catch (err) {
        console.error("❌ Error cargando archivos:", err);
      }
    }

    // Funciones para manejar el progreso del cliente
    async function cargarProgresoDelCliente(id) {
      try {
        const res = await fetch(`https://jawfish-saving-grossly.ngrok-free.app/progreso/${id}`);
        const progreso = await res.json();
        
        if (progreso && progreso.hitos) {
          renderizarHitos(progreso.hitos);
          actualizarBarraProgreso(progreso.hitos);
        } else {
          renderizarHitos([]);
          actualizarBarraProgreso([]);
        }
      } catch (err) {
        console.error("Error cargando progreso:", err);
        renderizarHitos([]);
        actualizarBarraProgreso([]);
      }
    }

    function renderizarHitos(hitos) {
      const container = document.getElementById('progress-steps');
      container.innerHTML = '';

      hitos.forEach((hito, index) => {
        const estadoOriginal = hito.estado?.toLowerCase() || 'pendiente';

        // Normaliza el estado a clases válidas
        let estadoClase = 'pending';
        let icon = '<i class="fas fa-clock"></i>'; // por defecto
        
        if (estadoOriginal.includes('completado') || estadoOriginal.includes('completed')) {
          estadoClase = 'completed';
          icon = '<i class="fas fa-check-circle"></i>';
        } else if (estadoOriginal.includes('proceso') || estadoOriginal.includes('current')) {
          estadoClase = 'current';
          icon = '<i class="fas fa-spinner fa-spin"></i>';
        }

        const step = document.createElement('div');
        step.className = `step ${estadoClase}`;

        const nota = hito.descripcion || hito.notas;
        const notasElement = nota ? `
          <div class="step-notes-container">
            <button class="step-notes-trigger">i</button>
            <div class="step-notes-bubble">${nota}</div>
          </div>
        ` : '';

        step.innerHTML = `
          <div class="step-icon">${icon}</div>
          <div class="step-info">
            <h3>${hito.nombre}</h3>
            <p>${hito.fecha || 'Sin fecha'}</p>
            ${nota ? `<small class="step-notes">${nota}</small>` : ''}
          </div>
        `;

        container.appendChild(step);
        
        // Animación de aparición escalonada
        setTimeout(() => {
          step.classList.add('visible');
        }, 150 * index);
        
        // Efecto click en iconos
        const iconElement = step.querySelector('.step-icon');
        iconElement.addEventListener('click', () => {
          iconElement.style.transform = 'scale(0.9)';
          setTimeout(() => {
            iconElement.style.transform = 'scale(1.1)';
          }, 100);
        });
      });
    }

    function actualizarBarraProgreso(hitos) {
      const totalHitos = hitos.length;
      
      // Normaliza el estado y filtra los completados
      const completados = hitos.filter(h => 
        h.estado?.toLowerCase() === 'completado' || 
        h.estado?.toLowerCase() === 'completed'
      ).length;

      const porcentaje = Math.round((completados / totalHitos) * 100) || 0;

      // Actualiza la UI
      document.getElementById('progress-percent').textContent = `${porcentaje}%`;
      document.getElementById('progress-fill').style.width = `${porcentaje}%`;

      const progressText = document.getElementById('progress-text');
      if (porcentaje === 0) {
        progressText.textContent = 'El proceso comenzará una vez completado el registro y pago.';
      } else if (porcentaje < 50) {
        progressText.textContent = '¡Vamos bien! Estamos en las primeras etapas del proceso.';
      } else if (porcentaje < 100) {
        progressText.textContent = '¡Vas muy bien! Estamos avanzando según lo planeado.';
      } else {
        progressText.textContent = '¡Felicidades! Has completado todo el proceso.';
      }
    }

    async function sendMessage() {
      const chatInput = document.getElementById('chat-message');
      const message = chatInput.value.trim();

      if (!message || !clienteId) return;

      try {
        const msgId = 'msg-' + Date.now(); // ID temporal hasta que el servidor responda

        // Mostrar mensaje localmente como enviado
        const msgEl = document.createElement('div');
        msgEl.className = 'message sent';
        msgEl.setAttribute('data-id', msgId); // Añadir ID al elemento
        msgEl.innerHTML = `
          ${message}
          <span class="message-time">
            ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
          </span>
        `;
        document.getElementById('messages-container').appendChild(msgEl);
        mensajesCargados.add(msgId); // Marcar como cargado inmediatamente
        scrollToBottom();

        // Enviar al servidor
        socket.emit('mensaje-cliente', {
          clienteId: clienteId,
          texto: message,
          fecha: new Date().toISOString()
        }, (response) => {
          if (response.status === 'error') {
            console.error('Error del servidor:', response.error);
          } else if (response._id) {
            // Actualizar el ID del mensaje con el del servidor
            const localMsg = document.querySelector(`[data-id="${msgId}"]`);
            if (localMsg) {
              localMsg.setAttribute('data-id', response._id);
              mensajesCargados.delete(msgId); // Eliminar el ID temporal
              mensajesCargados.add(response._id); // Añadir el ID del servidor
            }
          }
        });

        await fetch(`https://jawfish-saving-grossly.ngrok-free.app/mensajes/${clienteId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            autor: 'cliente',
            texto: message,
            fecha: new Date().toISOString()
          })
        });

        chatInput.value = '';
        scrollToBottom();
      } catch (err) {
        console.error('Error al enviar mensaje:', err);
      }
    }

    // UI Initialization
    document.addEventListener('DOMContentLoaded', () => {
      setupNavigation();
      setupChat();
      setupFileModal();
      setupProgressPanel();
      setupDependientesPanel();
    });

    function setupNavigation() {
      const menuToggle = document.getElementById('menu-toggle');
      const sidebar = document.getElementById('sidebar');
      
      // Toggle del menú móvil
      menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('active');
      });
      
      const navItems = document.querySelectorAll('.nav-item');
      
      navItems.forEach(item => {
        item.addEventListener('click', function() {
          navItems.forEach(navItem => navItem.classList.remove('active'));
          this.classList.add('active');
          
          const view = this.getAttribute('data-view');
          document.querySelectorAll('.content-panel').forEach(panel => {
            panel.classList.remove('active');
          });
          document.getElementById('welcome-box').classList.add('oculto');
          
          if (view) {
            document.getElementById(`vista-${view}`).classList.add('active');
            
            const titles = {
              chat: 'Chat con Asesor',
              info: 'Mi Información',
              documentos: 'Mis Documentos',
              progreso: 'Progreso del Caso',
              dependientes: 'Mis Dependientes'
            };
            document.getElementById('vista-titulo').textContent = titles[view];
          }
          
          // Cerrar el menú en móvil después de seleccionar una opción
          sidebar.classList.remove('active');
          
          if (view === 'chat') {
            scrollToBottom();
          }
          if (view === 'documentos') {
            cargarArchivosDelCliente(clienteId);
          }
          if (view === 'progreso') {
            cargarProgresoDelCliente(clienteId);
          }
        });
      });
    }

    function setupDependientesPanel() {
      const lista = document.getElementById('dependientes-lista');

      // Ejemplo de datos estáticos. Puedes hacer fetch aquí si los quieres traer del servidor
      const dependientes = [
        { nombre: 'María López', parentesco: 'Hija', edad: 12 },
        { nombre: 'Carlos López', parentesco: 'Hijo', edad: 10 }
      ];

      lista.innerHTML = ''; // Limpia antes de insertar

      dependientes.forEach(dep => {
        const card = document.createElement('div');
        card.className = 'info-card';
        card.innerHTML = `
          <h3>${dep.nombre}</h3>
          <p>Parentesco: ${dep.parentesco}</p>
          <p>Edad: ${dep.edad} años</p>
        `;
        lista.appendChild(card);
      });
    }

    function setupProgressPanel() {
      // Esta función se mantiene igual que en la versión original
      // pero se ha simplificado para móvil eliminando el formulario de hitos
    }

    function setupChat() {
      const sendBtn = document.getElementById('send-btn');
      const chatInput = document.getElementById('chat-message');
      
      sendBtn.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
    }

    function setupFileModal() {
      const fileBtn = document.getElementById('file-btn');
      const fileInput = document.getElementById('file-input');
      const dropArea = document.getElementById('drop-area');
      const btnSelectFile = document.querySelector('.btn-select-file');
      const btnCancel = document.querySelector('.btn-cancel');
      const btnSend = document.querySelector('.btn-send');
      const modal = document.getElementById('file-modal');
      const closeModal = document.querySelector('.close-modal');
      
      fileBtn.addEventListener('click', () => modal.style.display = 'flex');
      closeModal.addEventListener('click', () => modal.style.display = 'none');
      btnCancel.addEventListener('click', () => modal.style.display = 'none');
      btnSelectFile.addEventListener('click', () => fileInput.click());
      
      fileInput.addEventListener('change', handleFileSelect);
      
      // Drag and Drop Handlers
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
      });
      
      ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
      });
      
      dropArea.addEventListener('drop', handleDrop, false);
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      function highlight() {
        dropArea.classList.add('highlight');
      }
      
      function unhighlight() {
        dropArea.classList.remove('highlight');
      }
      
      function handleDrop(e) {
        const files = e.dataTransfer.files;
        handleFiles(files);
      }
      
      function handleFileSelect(e) {
        handleFiles(e.target.files);
      }
      
      function handleFiles(files) {
        if (!files.length) return;
        const file = files[0];
        const filePreview = document.getElementById('file-preview');

        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            filePreview.innerHTML = `
              <div class="preview-image">
                <img src="${e.target.result}" alt="Preview">
                <p>${file.name}</p>
              </div>
            `;
            btnSend.disabled = false;
          };
          reader.readAsDataURL(file);
        } else {
          filePreview.innerHTML = `
            <div class="preview-file">
              <i class="fas fa-file"></i>
              <p>${file.name}</p>
              <small>${(file.size / 1024).toFixed(2)} KB</small>
            </div>
          `;
          btnSend.disabled = false;
        }
      }
      
      btnSend.addEventListener('click', () => {
        alert('Archivo enviado con éxito');
        modal.style.display = 'none';
        document.getElementById('file-preview').innerHTML = '';
        btnSend.disabled = true;
      });
    }
  </script>
</body>
</html>